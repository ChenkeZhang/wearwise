<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WearWise</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=W&background=3b82f6&color=fff&size=512&length=1&font-size=0.6&rounded=false">
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; user-select: none; }
        .glass { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-blue-500 min-h-screen text-white flex flex-col items-center transition-colors duration-1000" id="bg">

    <div id="install-banner" class="hidden w-full bg-white/90 backdrop-blur text-blue-600 px-4 py-3 flex justify-between items-center shadow-lg fixed top-0 left-0 z-50">
        <div class="flex items-center space-x-3">
            <div class="bg-blue-500 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold">W</div>
            <div class="text-sm leading-tight">
                <p class="font-bold">å®‰è£… WearWise</p>
                <p class="text-xs opacity-80">ç‚¹å‡»åº•éƒ¨åˆ†äº« <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4b/Feather-core-share.svg/1200px-Feather-core-share.svg.png" class="inline w-3 h-3"> æ·»åŠ åˆ°ä¸»å±å¹•</p>
            </div>
        </div>
        <button onclick="closeBanner()" class="text-gray-400 font-bold px-2">&times;</button>
    </div>

    <div class="flex-1 flex flex-col items-center justify-center w-full max-w-md p-6 pt-16">
        <div class="text-9xl mb-6 filter drop-shadow-lg transition-all duration-500 transform hover:scale-110" id="icon">ğŸ‘‹</div>
        
        <h1 class="text-4xl font-bold mb-2 text-center leading-tight drop-shadow-md min-h-[3rem]" id="suggestion">å‡†å¤‡å¥½äº†</h1>
        
        <div id="data-panel" class="glass rounded-2xl p-5 mt-8 w-full space-y-3 text-center shadow-xl hidden opacity-0 transition-opacity duration-500">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-xs opacity-60 uppercase tracking-wider">ä½“æ„Ÿæ¸©åº¦</p>
                    <p class="text-2xl font-bold"><span id="temp">--</span>Â°C</p>
                </div>
                <div>
                    <p class="text-xs opacity-60 uppercase tracking-wider" id="rain-label">é™æ°´æ¦‚ç‡</p>
                    <p class="text-2xl font-bold"><span id="rain">--</span>%</p>
                </div>
            </div>
            <div class="border-t border-white/10 pt-2 mt-2">
                <p class="text-xs opacity-50 flex items-center justify-center gap-1">
                    ğŸ“ <span id="city">--</span> <span id="loc-method" class="text-[10px] opacity-70 border border-white/30 rounded px-1 ml-1"></span>
                </p>
            </div>
        </div>

        <button id="refresh-btn" onclick="startLocation()" class="mt-10 bg-white text-blue-600 hover:bg-gray-100 px-10 py-4 rounded-full font-bold text-lg shadow-lg transition-all active:scale-95 flex items-center gap-2">
            ğŸš€ å¼€å§‹åˆ†æå¤©æ°”
        </button>
        
        <p id="error-msg" class="mt-4 text-sm text-red-200 hidden bg-red-500/20 px-4 py-2 rounded-lg text-center"></p>
    </div>

    <script>
        const API_KEY = "3806f393ab45ce4b1b18655b0d5733c0"; 
        let locationTimeout;

        // æ ¸å¿ƒç®—æ³• v1.1
        function analyze(feelsLike, rainPop) {
            let result = { icon: "ğŸ¤”", text: "", bg: "bg-blue-500" };
            if (rainPop >= 0.3) { 
                if (feelsLike < 2) {
                    result.icon = "â„ï¸"; result.text = "ä¸‹é›ªäº†ï¼"; result.bg = "bg-slate-400";
                    document.getElementById('rain-label').innerText = "é™é›ªæ¦‚ç‡";
                } else {
                    result.icon = "â˜”ï¸"; result.text = rainPop > 0.5 ? "å¸¦ä¼ï¼è‚¯å®šä¸‹é›¨" : "å¸¦ä¼ï¼å¯èƒ½ä¸‹é›¨"; result.bg = "bg-gray-600";
                    document.getElementById('rain-label').innerText = "é™é›¨æ¦‚ç‡";
                }
                return result;
            } else {
                document.getElementById('rain-label').innerText = "é™æ°´æ¦‚ç‡";
            }
            if (feelsLike > 23) { result.icon = "â˜€ï¸"; result.text = "çŸ­è¢– / çƒ­è£¤"; result.bg = "bg-orange-500"; }
            else if (feelsLike >= 16) { result.icon = "ğŸ‘•"; result.text = "é•¿è¢– / è–„å¤–å¥—"; result.bg = "bg-teal-500"; }
            else if (feelsLike >= 10) { result.icon = "ğŸ§¥"; result.text = "å«è¡£ / å¤¹å…‹"; result.bg = "bg-indigo-500"; }
            else if (feelsLike >= 5) { result.icon = "ğŸ§£"; result.text = "åšå¤–å¥— / å¤§è¡£"; result.bg = "bg-purple-600"; }
            else { result.icon = "ğŸ¥¶"; result.text = "ç¾½ç»’æœ / ä¿å‘½"; result.bg = "bg-slate-800"; }
            return result;
        }

        // ã€ä¸€çº§ã€‘å¼€å§‹å®šä½æµç¨‹ (ç”±ç”¨æˆ·ç‚¹å‡»è§¦å‘)
        function startLocation() {
            setLoadingState(true, "æ­£åœ¨è¿æ¥å«æ˜Ÿ (GPS)...");
            
            if (!navigator.geolocation) {
                console.warn("ä¸æ”¯æŒGPSï¼Œé™çº§åˆ°IPå®šä½");
                getWeatherByIP(); // ä¸æ”¯æŒGPSï¼Œç›´æ¥ç”¨IP
                return;
            }

            // 5ç§’ GPS å¼ºåˆ¶è¶…æ—¶ç‚¸å¼¹
            if (locationTimeout) clearTimeout(locationTimeout);
            locationTimeout = setTimeout(() => {
                console.warn("GPSè¶…æ—¶ï¼Œé™çº§åˆ°IPå®šä½");
                getWeatherByIP(); // è¶…æ—¶äº†ï¼Œè½¬ç”¨ IP å®šä½
            }, 5000); 

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    clearTimeout(locationTimeout); // GPSæˆåŠŸï¼Œæ‹†å¼¹
                    fetchWeatherData(position.coords.latitude, position.coords.longitude, "GPSç²¾ç¡®åŸºç«™");
                }, 
                (err) => {
                    clearTimeout(locationTimeout); // GPSå¤±è´¥ï¼Œæ‹†å¼¹
                    console.warn("GPSå¤±è´¥:", err.message);
                    // å¤±è´¥äº†ï¼Œè½¬ç”¨ IP å®šä½
                    setLoadingState(true, "GPSä¿¡å·å¼±ï¼Œå°è¯•ç½‘ç»œå®šä½...");
                    getWeatherByIP();
                }, 
                { enableHighAccuracy: false, timeout: 4000, maximumAge: 60000 }
            );
        }

        // ã€äºŒçº§ã€‘IP å®šä½ (å¤‡ç”¨æ–¹æ¡ˆ)
        async function getWeatherByIP() {
            try {
                // ä½¿ç”¨å…è´¹çš„ ipapi.co è·å–ç²—ç•¥ä½ç½®
                const ipResponse = await fetch('https://ipapi.co/json/');
                const ipData = await ipResponse.json();
                
                if (!ipData.latitude || !ipData.longitude) throw new Error("IPå®šä½å¤±è´¥");
                
                console.log("IPå®šä½æˆåŠŸ:", ipData.city);
                fetchWeatherData(ipData.latitude, ipData.longitude, "ç½‘ç»œç²—ç•¥å®šä½");

            } catch (error) {
                console.error(error);
                // ã€ä¸‰çº§å…œåº•ã€‘å¦‚æœè¿IPéƒ½å¤±è´¥äº† (æå°‘è§)
                showError("å®šä½å…¨éƒ¨åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
                setLoadingState(false, "åˆ·æ–°é‡è¯•");
            }
        }

        // é€šç”¨å¤©æ°”æ•°æ®è·å–å‡½æ•°
        async function fetchWeatherData(lat, lon, methodTxt) {
            setLoadingState(true, "åˆ†ææ°”è±¡æ•°æ®...");
            try {
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=zh_cn&appid=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                if(data.cod !== 200) throw new Error(data.message);

                const feelsLike = Math.round(data.main.feels_like);
                let rainPop = 0;
                if (data.rain || data.snow) rainPop = 1; 
                if (data.weather[0].main === 'Rain' || data.weather[0].main === 'Snow') rainPop = 0.8;

                const advice = analyze(feelsLike, rainPop);
                updateUI(advice, feelsLike, rainPop, data.name, methodTxt);
                
            } catch (error) {
                showError("å¤©æ°”æ•°æ®è·å–å¤±è´¥");
                console.error(error);
                setLoadingState(false, "é‡è¯•");
            }
        }

        function updateUI(advice, feelsLike, rainPop, cityName, methodTxt) {
            document.getElementById('icon').innerText = advice.icon;
            document.getElementById('suggestion').innerText = advice.text;
            document.getElementById('temp').innerText = feelsLike;
            document.getElementById('rain').innerText = (rainPop * 100).toFixed(0);
            document.getElementById('city').innerText = cityName;
            document.getElementById('loc-method').innerText = methodTxt;
            document.getElementById('bg').className = `min-h-screen text-white flex flex-col items-center transition-colors duration-1000 ${advice.bg}`;
            
            // æ˜¾ç¤ºæ•°æ®é¢æ¿
            const panel = document.getElementById('data-panel');
            panel.classList.remove('hidden');
            setTimeout(() => panel.classList.remove('opacity-0'), 100);

            setLoadingState(false, "åˆ·æ–°å»ºè®®");
        }

        function setLoadingState(isLoading, text) {
            const btn = document.getElementById('refresh-btn');
            const errorMsg = document.getElementById('error-msg');
            const suggestion = document.getElementById('suggestion');
            
            errorMsg.classList.add('hidden');
            if (isLoading) {
                btn.innerText = "å¤„ç†ä¸­...";
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.disabled = true;
                suggestion.innerText = text;
            } else {
                btn.innerText = text || "åˆ·æ–°å»ºè®®";
                btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-white', 'text-blue-600', 'text-lg', 'px-10', 'py-4');
                // æˆåŠŸåæŒ‰é’®å˜å°å˜é€æ˜
                btn.classList.add('bg-white/20', 'hover:bg-white/30', 'text-white', 'border', 'border-white/40', 'px-8', 'py-3');
                btn.disabled = false;
            }
            if (locationTimeout) clearTimeout(locationTimeout);
        }

        function showError(msg) {
            const errorMsg = document.getElementById('error-msg');
            document.getElementById('suggestion').innerText = "å“å‘€...";
            errorMsg.innerText = msg;
            errorMsg.classList.remove('hidden');
        }

        function checkInstall() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isStandalone = window.navigator.standalone || (window.matchMedia('(display-mode: standalone)').matches);
            if (isIOS && !isStandalone) document.getElementById('install-banner').classList.remove('hidden');
        }
        function closeBanner() { document.getElementById('install-banner').classList.add('hidden'); }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        // âš ï¸ æ³¨æ„ï¼šè¿™é‡Œä¸å†è‡ªåŠ¨è°ƒç”¨ getWeather()
        setTimeout(checkInstall, 1000);
    </script>
</body>
</html>
