<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WearWise</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=W&background=3b82f6&color=fff&size=512&length=1&font-size=0.6&rounded=false">
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; user-select: none; }
        .glass { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-blue-500 min-h-screen text-white flex flex-col items-center transition-colors duration-1000" id="bg">

    <div id="install-banner" class="hidden w-full bg-white/90 backdrop-blur text-blue-600 px-4 py-3 flex justify-between items-center shadow-lg fixed top-0 left-0 z-50">
        <div class="flex items-center space-x-3">
            <div class="bg-blue-500 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold">W</div>
            <div class="text-sm leading-tight">
                <p class="font-bold">å®‰è£… WearWise</p>
                <p class="text-xs opacity-80">ç‚¹å‡»åº•éƒ¨åˆ†äº« <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4b/Feather-core-share.svg/1200px-Feather-core-share.svg.png" class="inline w-3 h-3"> æ·»åŠ åˆ°ä¸»å±å¹•</p>
            </div>
        </div>
        <button onclick="closeBanner()" class="text-gray-400 font-bold px-2">&times;</button>
    </div>

    <div class="flex-1 flex flex-col items-center justify-center w-full max-w-md p-6 pt-16">
        <div class="text-9xl mb-6 filter drop-shadow-lg transition-all duration-500 transform hover:scale-110" id="icon">ğŸ¤”</div>
        
        <h1 class="text-4xl font-bold mb-2 text-center leading-tight drop-shadow-md" id="suggestion">æ­£åœ¨è¿æ¥å«æ˜Ÿ...</h1>
        
        <div class="glass rounded-2xl p-5 mt-8 w-full space-y-3 text-center shadow-xl">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-xs opacity-60 uppercase tracking-wider">ä½“æ„Ÿæ¸©åº¦</p>
                    <p class="text-2xl font-bold"><span id="temp">--</span>Â°C</p>
                </div>
                <div>
                    <p class="text-xs opacity-60 uppercase tracking-wider" id="rain-label">é™æ°´æ¦‚ç‡</p>
                    <p class="text-2xl font-bold"><span id="rain">--</span>%</p>
                </div>
            </div>
            <div class="border-t border-white/10 pt-2 mt-2">
                <p class="text-xs opacity-50 flex items-center justify-center gap-1">
                    ğŸ“ <span id="city">å®šä½ä¸­...</span>
                </p>
            </div>
        </div>

        <button id="refresh-btn" onclick="getWeather()" class="mt-10 bg-white/20 hover:bg-white/30 text-white border border-white/40 px-8 py-3 rounded-full font-medium backdrop-blur-sm transition-all active:scale-95 flex items-center gap-2">
            åˆ·æ–°æ•°æ®
        </button>
        
        <p id="error-msg" class="mt-4 text-sm text-red-200 hidden bg-red-500/20 px-4 py-2 rounded-lg"></p>
    </div>

    <script>
        // âš ï¸ æŒ‡æŒ¥å®˜ï¼Œè¯·ç¡®è®¤ Key æ˜¯å¦æ­£ç¡®
        const API_KEY = "3806f393ab45ce4b1b18655b0d5733c0"; 

        // æ ¸å¿ƒç®—æ³• v1.1 (åŠ å…¥äº†ä¸‹é›ªé€»è¾‘)
        function analyze(feelsLike, rainPop) {
            let result = { icon: "ğŸ¤”", text: "", bg: "bg-blue-500" };

            // 1. å…ˆåˆ¤æ–­æ¶åŠ£å¤©æ°” (é›ª > é›¨)
            if (rainPop >= 0.3) { // é—¨æ§›é™åˆ°30%
                // å¦‚æœä½“æ„Ÿä½äº 2åº¦ï¼Œåˆ¤å®šä¸ºé›ª
                if (feelsLike < 2) {
                    result.icon = "â„ï¸";
                    result.text = "ä¸‹é›ªäº†ï¼";
                    result.bg = "bg-slate-400"; // é›ªå¤©ç°è‰²
                    document.getElementById('rain-label').innerText = "é™é›ªæ¦‚ç‡";
                } else {
                    result.icon = "â˜”ï¸";
                    result.text = rainPop > 0.5 ? "å¸¦ä¼ï¼è‚¯å®šä¸‹é›¨" : "å¸¦ä¼ï¼å¯èƒ½ä¸‹é›¨";
                    result.bg = "bg-gray-600"; // é›¨å¤©æ·±ç°
                    document.getElementById('rain-label').innerText = "é™é›¨æ¦‚ç‡";
                }
                return result;
            } else {
                document.getElementById('rain-label').innerText = "é™æ°´æ¦‚ç‡";
            }

            // 2. å†åˆ¤æ–­æ¸©åº¦
            if (feelsLike > 23) {
                result.icon = "â˜€ï¸"; result.text = "çŸ­è¢– / çƒ­è£¤"; result.bg = "bg-orange-500";
            } else if (feelsLike >= 16) {
                result.icon = "ğŸ‘•"; result.text = "é•¿è¢– / è–„å¤–å¥—"; result.bg = "bg-teal-500";
            } else if (feelsLike >= 10) {
                result.icon = "ğŸ§¥"; result.text = "å«è¡£ / å¤¹å…‹"; result.bg = "bg-indigo-500";
            } else if (feelsLike >= 5) {
                result.icon = "ğŸ§£"; result.text = "åšå¤–å¥— / å¤§è¡£"; result.bg = "bg-purple-600";
            } else {
                result.icon = "ğŸ¥¶"; result.text = "ç¾½ç»’æœ / ä¿å‘½"; result.bg = "bg-slate-800";
            }
            return result;
        }

        // è·å–å¤©æ°” (å¸¦è¶…æ—¶ä¿æŠ¤)

        // æ›¿æ¢æ•´ä¸ª getWeather å‡½æ•°
let locationTimeout; // å…¨å±€å˜é‡å­˜æ”¾å®šæ—¶å™¨

function getWeather() {
    const btn = document.getElementById('refresh-btn');
    const errorMsg = document.getElementById('error-msg');
    
    // é‡ç½®çŠ¶æ€
    btn.innerText = "æ­£åœ¨è¿æ¥å«æ˜Ÿ...";
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    btn.disabled = true; // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
    errorMsg.classList.add('hidden');
    document.getElementById('suggestion').innerText = "æ­£åœ¨è¿æ¥å«æ˜Ÿ...";

    if (!navigator.geolocation) {
        showError("ä½ çš„æ‰‹æœºä¸æ”¯æŒå®šä½");
        return;
    }

    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (locationTimeout) clearTimeout(locationTimeout);

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ‰‹åŠ¨è®¾ç½®ä¸€ä¸ª 10ç§’ çš„å¼ºåˆ¶è¶…æ—¶ç‚¸å¼¹
    // å¦‚æœ 10ç§’åè¿˜æ²¡æœ‰ç»“æœï¼Œç›´æ¥å¼ºåˆ¶æŠ¥é”™ï¼Œä¸å†ç­‰å¾…ç³»ç»Ÿ
    locationTimeout = setTimeout(() => {
        console.warn("å®šä½æ‰‹åŠ¨è¶…æ—¶è§¦å‘");
        showError("å®šä½è¶…æ—¶ (iOSé™åˆ¶)ï¼Œè¯·ç‚¹æŒ‰é’®é‡è¯•");
    }, 10000); // 10ç§’

    const options = {
        enableHighAccuracy: false, // å…³é—­é«˜ç²¾åº¦ï¼Œå°è¯•ç”¨åŸºç«™å®šä½ï¼Œé€Ÿåº¦æ›´å¿«
        timeout: 8000, // ç³»ç»Ÿçº§è¶…æ—¶
        maximumAge: 60000 // å…è®¸ä½¿ç”¨1åˆ†é’Ÿå†…çš„ç¼“å­˜ä½ç½®
    };

    navigator.geolocation.getCurrentPosition(async (position) => {
        // ã€æˆåŠŸå›è°ƒã€‘
        clearTimeout(locationTimeout); // æ‹†é™¤ç‚¸å¼¹
        
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        btn.innerText = "åˆ†ææ•°æ®...";
        document.getElementById('suggestion').innerText = "åˆ†ææ•°æ®...";

        try {
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=zh_cn&appid=${API_KEY}`;
            
            const response = await fetch(url);
            const data = await response.json();
            if(data.cod !== 200) throw new Error(data.message);

            const feelsLike = Math.round(data.main.feels_like);
            let rainPop = 0;
            if (data.rain || data.snow) rainPop = 1; 
            if (data.weather[0].main === 'Rain' || data.weather[0].main === 'Snow') rainPop = 0.8;

            const advice = analyze(feelsLike, rainPop);
            updateUI(advice, feelsLike, rainPop, data.name);
            
        } catch (error) {
            showError("è·å–å¤©æ°”å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            console.error(error);
        }

    }, (err) => {
        // ã€å¤±è´¥å›è°ƒã€‘
        clearTimeout(locationTimeout); // æ‹†é™¤ç‚¸å¼¹
        console.warn("å®šä½å¤±è´¥å›è°ƒ:", err.code, err.message);
        let msg = "å®šä½å¤±è´¥";
        if (err.code === 1) msg = "è¯·å»è®¾ç½®-éšç§å¼€å¯å®šä½æƒé™";
        if (err.code === 2) msg = "GPSä¿¡å·å¼±ï¼Œè¯·ç§»æ­¥å¼€é˜”åœ°";
        if (err.code === 3) msg = "å®šä½è¶…æ—¶ï¼Œè¯·ç‚¹æŒ‰é’®é‡è¯•";
        showError(msg);
    }, options);
}

// è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°ç•Œé¢
function updateUI(advice, feelsLike, rainPop, cityName) {
    document.getElementById('icon').innerText = advice.icon;
    document.getElementById('suggestion').innerText = advice.text;
    document.getElementById('temp').innerText = feelsLike;
    document.getElementById('rain').innerText = (rainPop * 100).toFixed(0);
    document.getElementById('city').innerText = cityName;
    document.getElementById('bg').className = `min-h-screen text-white flex flex-col items-center transition-colors duration-1000 ${advice.bg}`;
    
    resetButton();
}

// è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºé”™è¯¯
function showError(msg) {
    document.getElementById('suggestion').innerText = "é‡åˆ°é—®é¢˜ ğŸ¤”";
    const errorMsg = document.getElementById('error-msg');
    errorMsg.innerText = msg;
    errorMsg.classList.remove('hidden');
    resetButton();
}

// è¾…åŠ©å‡½æ•°ï¼šé‡ç½®æŒ‰é’®çŠ¶æ€
function resetButton() {
    const btn = document.getElementById('refresh-btn');
    btn.innerText = "åˆ·æ–°å»ºè®®";
    btn.classList.remove('opacity-50', 'cursor-not-allowed');
    btn.disabled = false;
    if (locationTimeout) clearTimeout(locationTimeout);
}


        // PWA å¼•å¯¼æ£€æµ‹ (é¡¶éƒ¨æ¨ªå¹…)
        function checkInstall() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isStandalone = window.navigator.standalone || (window.matchMedia('(display-mode: standalone)').matches);
            
            if (isIOS && !isStandalone) {
                // åªæœ‰ iOS ä¸”éå…¨å±æ¨¡å¼æ‰æ˜¾ç¤º
                document.getElementById('install-banner').classList.remove('hidden');
            }
        }

        function closeBanner() {
            document.getElementById('install-banner').classList.add('hidden');
        }

        // å¯åŠ¨
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        getWeather();
        setTimeout(checkInstall, 1000);
    </script>
</body>
</html>
